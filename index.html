<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <style type="text/css">

body {
  margin: 0;
  padding: 0;
}

* {
  box-sizing: border-box;
}

body, input, textarea {
  font-family: 'Courier', monospace;
  font-size: 13px;
}

#container {
  position: absolute;
  width: 960px;
  height: 600px;
  background-color: beige;
}

#editor-pane {
  background-color: #e47;
  position: absolute;
  top: 0;
  left: 0;
  width: 480px;
  height: 600px;
}

#cli-pane {
  background-color: #99ff88;
  position: absolute;
  top: 0;
  right: 0;
  width: 480px;
  height: 600px;
}

textarea#editor {
  height: 480px;
  width: 480px;
  border: 0;
  resize: none;
}

.inset-border {
  border-top: 3px solid gray;
  border-left: 3px solid gray;
  border-right: 3px solid lightgray;
  border-bottom: 3px solid lightgray;
}

#log {
  position: absolute;
  height: 480px;
  width: 480px;
  background-color: silver;
}

#log-items {
  position: absolute;
  bottom: 0;
  width: 474px;
  max-height: 474px;
  overflow-y: auto;
  overflow-x: hidden;
}

#terminal {
  position: absolute;
  top: 480px;
  width: 480px;
  height: 52px;
  background-color: black;
  color: goldenrod;
  padding-left: 5px;
  white-space: pre-line;
  line-height: 22px;
}

input#command-line {
  border: none;
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  width: 474px;
  padding-top: 20px;
  color: #0e0;
  background: transparent;
  padding-left: 20.5px;
}

.paper {
  white-space: pre;
  overflow: hidden;
  margin: 5px;
  padding: 5px;
  width: 450px;
  background-color: #f0f0f0;
}

/*.paper:nth-child(even) {
  background-color: #e0e0e0;
}*/

    </style>
  </head>
  <body>
    <div id="container">
      <div id="editor-pane">
        <textarea id="editor"></textarea>
      </div>
      <div id="cli-pane">
        <div id="log" class="inset-border">
          <div id="log-items">
          </div>
        </div>
        <div id="terminal" class="inset-border"><span id="breadcrumbs"></span>
          <input id="command-line" type="text">
        </div>

      </div>
    </div>

    <script type="text/javascript">

const cliInput = document.getElementById('command-line')
const logItemsElement = document.getElementById('log-items')
const editor = document.getElementById('editor')

// the HTML element we will append logs to.
// if null, it means we will create a new element and
// append logs to that.
let currentLogElement = null
let validTokensForInput = null

editor.value = localStorage['file'] || ''

editor.addEventListener('blur', function() {
  localStorage['file'] = editor.value
})

cliInput.addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    event.preventDefault()
    if (programState === 'waitingForInput') {
      log('> ' + cliInput.value)
      programState = 'running'
      program.next(cliInput.value)
    } else {
      log(cliInput.value)
    }

    cliInput.value = ''
  } else if (event.key === 'Escape') {
    event.preventDefault()
    if (programState !== 'running') {
      programState = 'running'
      program.throw('Canceled.')
      cliInput.value = ''
    }
  }
})

////////////////////////////////////////////////////////////
// API FOR USER PROGRAMS
////////////////////////////////////////////////////////////

function log(text, color='black') {
  if (!currentLogElement) {
    let newLogElement = document.createElement('div')
    newLogElement.classList.add('paper')
    logItemsElement.appendChild(newLogElement)
    currentLogElement = newLogElement
  } else {
    currentLogElement.appendChild(document.createElement('br'))
  }
  let span = document.createElement('span')
  span.style.color = color
  span.innerText = text
  currentLogElement.appendChild(span)
  logItemsElement.scrollTop = 2147483647
}

function ask(text) {
  log(text, '#a40')
}

function inform(text) {
  log(text, '#00c')
}

function alert(text) {
  log(text, '#f40')
}

function cutLog() {
  currentLogElement = null
}

function sleep(seconds) {
  programState = 'sleeping'
  setTimeout(function() {
    programState = 'running'
    program.next()
  }, seconds * 1000)
}

function save() {
  localStorage['state'] = globalsAsJson()
}

function help() {
  let output = 'Available symbols:\n'
    + Object.keys(userGlobalNames).sort().join('\n')
  inform(output)
}

let userGlobalNames = {}
function initializeGlobals(initialValues) {
  for (let key in userGlobalNames) {
    if (!(key in initialValues)) {
      // key has been removed from the program
      delete window[key]
      delete userGlobalNames[key]
    }
  }

  for (let key in initialValues) {
    // if the type of the variable has changed, we need to
    // reinitialize it. Reinitialize functions too, since
    // they should be stateless and the programmer may have
    // changed the function definition
    if (typeof initialValues[key] === 'function'
      || !sameType(window[key], initialValues[key])) {
      window[key] = initialValues[key]
      userGlobalNames[key] = true
    }
  }

  function sameType(a, b) {
    var toS = Object.prototype.toString
    return typeof a === typeof b && toS.call(a) === toS.call(b)
  }
}

// load the globals from the saved JSON
initializeGlobals(JSON.parse(localStorage['state'] || '{}'))

function getUserInput(validTokens) {
  if (programState !== 'running') {
    throw 'You asked for user input, but it looks like the program is currently ' + programState + '. This probably means you forgot to `yield`.'
  }

  cliInput.focus()
  programState = 'waitingForInput'
}

function *getUserInputIn(validTokens) {
  if (typeof validTokens === 'string') {
    validTokens = validTokens.split('')
  }

  if (validTokens) {
    validTokensForInput = validTokens
  }

  getInput: for (;;) {

  let answer = yield getUserInput()
  if (!validTokens.includes(answer)) {
    alert('Please enter ' + conjunctivePhrase(validTokens))
    continue getInput
  }

  return answer
}}

////////////////////////////////////////////////////////////
// UTILITY FUNCTIONS
////////////////////////////////////////////////////////////

function globalsAsJson() {
  let forJson = {}
  for (let key in userGlobalNames) {
    forJson[key] = window[key]
  }
  return JSON.stringify(forJson)
}

function conjunctivePhrase(list) {
  if (list.length <= 2) {
    return list.join(' or ')
  } else {
    return list[0] + ', ' + conjunctivePhrase(list.slice(1))
  }
}

const modeStack = []

function pushMode(functionName) {
  modeStack.push(functionName)
  breadcrumbs.innerText = renderModeStack(modeStack)
}

function popMode() {
  modeStack.pop()
  breadcrumbs.innerText = renderModeStack(modeStack)
}

function renderModeStack(stack) {
  let renderableStack = stack
  let truncated = false
  while (totalLength(renderableStack) > 50) {
    truncated = true;
    renderableStack = renderableStack.slice(1)
  }
  return (truncated ? '... ' : '') +
    renderableStack
      .filter(a => a)
      .join(' > ') + '\n$'

  function totalLength(segments) {
    if (segments.length === 0) return 0

    return ' > '.length * segments.length - 1
      + segments.reduce((sum, seg) => sum + seg.length, 0)
  }
}

////////////////////////////////////////////////////////////
// START OF MAIN PROGRAM
////////////////////////////////////////////////////////////

// the program is a generator function that yields
// when it wants user input.
const program = Main__()
let programState = 'running'
program.next()

function *Main__() {
  inform('Initializing GrumpyOS...')
  cutLog()

  mainLoop: while (true) {
    yield *mode(Shell)
  }

  function *Shell() {
    cutLog()
    yield sleep(0.6)
    ask('What do you want??')
    ask('1: your money')
    ask('2: your life')
    ask('3: nothing, I guess')

    parseInput:
    switch (yield *getUserInputIn('12345')) {
      case '1':
      inform("Well, yah can't have it!")
      break parseInput

      case '2':
      inform("I'm not afraid a you!")
      break parseInput

      case '3':
      inform("Well whatcha flappin yer mouth for then?")
      break parseInput

      case '4':
      ask("Hey buddy, want to eval some JavaScript? [y/n]")
      switch (yield *getUserInputIn('yn')) {
        case 'y':
        yield *mode(JSPrompt)
        break parseInput

        case 'n':
        inform('Okay then.')
        break parseInput
      }

      case '5':
      inform("Running your program starting from function `main`")
      yield *mode(RunProgram)
      break parseInput
    }
  }
}

function *JSPrompt() {
  // ensure that any functions we might want to call exist
  initUserProgram()

  ask('Okay, enter some code to run (Press ESC to leave)')
  yield *repeatUntilCanceled(getAndRunScript)
  inform('Bye!')

  function *getAndRunScript() {
    cutLog()
    let script = yield getUserInput()
    try {
      let result = eval(script)
      if (typeof result !== 'undefined') {
        inform(result)
      }
    } catch (e) {
      alert('' + e)
    }
  }
}

function *RunProgram() {
  initUserProgram()
  // assume the code defines a function like
  // program.main = function*() { ... }
  cutLog()
  yield *mode(window.main)
  cutLog()
  save()
  inform("Program completed.")
}

function initUserProgram() {
  let code = editor.value
  new Function('program', code)(window)
}

function *mode(generator) {
  try {
    pushMode(generator.name)
    yield *generator()
  } catch (canceled) {
    alert(canceled)
  }
  popMode()
}

function *repeatUntilCanceled(generator) {
  try {
    while (true) yield *generator()
  } catch (canceled) {
    alert(canceled)
  }
}

    </script>
  </body>
</html>
